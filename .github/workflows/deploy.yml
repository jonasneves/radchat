name: Deploy

on:
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'Duration in hours (max 5.5)'
        required: false
        default: '5'
      auto_restart:
        description: 'Auto-restart before timeout'
        required: false
        default: 'true'
        type: boolean
      tunnel_replicas:
        description: 'Tunnel HA connections (1-4)'
        required: false
        default: '2'

  repository_dispatch:
    types: [restart-deploy]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    permissions:
      actions: write
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Fetch ACR cache from data branch
        run: |
          git fetch origin data:data 2>/dev/null || true
          if git rev-parse --verify data >/dev/null 2>&1; then
            git checkout data -- src/data/acr_criteria.json 2>/dev/null || echo "No cache yet"
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Cancel previous workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PREVIOUS_RUN_ID=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/runs?status=in_progress" \
            | jq -r ".workflow_runs[] | select(.id < ${{ github.run_id }}) | .id" | head -1)

          if [ -n "$PREVIOUS_RUN_ID" ] && [ "$PREVIOUS_RUN_ID" != "null" ]; then
            echo "Cancelling previous workflow: $PREVIOUS_RUN_ID"
            curl -s -X POST \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/$PREVIOUS_RUN_ID/cancel"
            sleep 5
          fi

      - name: Start server
        env:
          GH_MODELS_TOKEN: ${{ secrets.GH_MODELS_TOKEN }}
          DUKE_CLIENT_ID: radchat
          DUKE_CLIENT_SECRET: ${{ secrets.DUKE_CLIENT_SECRET }}
          FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
        run: |
          gunicorn --bind 0.0.0.0:5000 --workers 2 --timeout 120 src.server:app &
          for i in {1..15}; do
            if curl -sf http://localhost:5000/health > /dev/null 2>&1; then
              echo "RadChat server started (gunicorn)"
              exit 0
            fi
            sleep 1
          done
          echo "Server failed to start"
          exit 1

      - name: Setup Cloudflare Tunnel
        run: |
          REPLICAS="${{ github.event.client_payload.tunnel_replicas || github.event.inputs.tunnel_replicas || '2' }}"
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          ./cloudflared tunnel --no-autoupdate --ha-connections "$REPLICAS" run --token "${{ secrets.TUNNEL_TOKEN }}" &
          sleep 5
          echo "Tunnel started with $REPLICAS HA connections"

      - name: Monitor
        env:
          RESTART_TOKEN: ${{ secrets.GH_MODELS_TOKEN }}
        run: |
          DURATION_HOURS="${{ github.event.client_payload.duration_hours || github.event.inputs.duration_hours || '5' }}"
          DURATION=$(awk "BEGIN {printf \"%.0f\", $DURATION_HOURS * 3600}")
          RESTART_THRESHOLD=$((DURATION - 360))
          START_TIME=$(date +%s)
          RESTART_TRIGGERED=false

          AUTO_RESTART="${{ github.event.client_payload.auto_restart || github.event.inputs.auto_restart }}"
          if [ -z "$AUTO_RESTART" ]; then
            AUTO_RESTART="true"
          fi

          echo "Duration: ${DURATION_HOURS}h (${DURATION}s) | Restart at: ${RESTART_THRESHOLD}s | Auto-restart: $AUTO_RESTART | Token set: $([ -n \"$RESTART_TOKEN\" ] && echo yes || echo no)"

          while true; do
            ELAPSED=$(($(date +%s) - START_TIME))
            REMAINING=$((DURATION - ELAPSED))

            if ! curl -sf http://localhost:5000/health > /dev/null; then
              echo "Health check failed, restarting server..."
              pkill -f gunicorn || true
              gunicorn --bind 0.0.0.0:5000 --workers 2 --timeout 120 src.server:app &
              sleep 3
            fi

            printf "[%s] RadChat running | %dm elapsed | %dm remaining\n" \
              "$(date '+%H:%M:%S')" "$((ELAPSED/60))" "$((REMAINING/60))"

            if [ "$ELAPSED" -gt "$RESTART_THRESHOLD" ] && [ "$RESTART_TRIGGERED" = "false" ]; then
              if [ "$AUTO_RESTART" = "true" ] && [ -n "$RESTART_TOKEN" ]; then
                echo "Triggering restart..."

                REPLICAS="${{ github.event.client_payload.tunnel_replicas || github.event.inputs.tunnel_replicas || '2' }}"
                RESPONSE=$(curl -sX POST \
                  -H "Accept: application/vnd.github+json" \
                  -H "Authorization: Bearer $RESTART_TOKEN" \
                  "https://api.github.com/repos/${{ github.repository }}/dispatches" \
                  -d "{\"event_type\":\"restart-deploy\",\"client_payload\":{\"duration_hours\":\"$DURATION_HOURS\",\"auto_restart\":true,\"tunnel_replicas\":\"$REPLICAS\"}}" \
                  -w "\nHTTP_STATUS:%{http_code}" 2>&1)

                HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)

                if [ "$HTTP_CODE" = "204" ]; then
                  echo "SUCCESS: Restart triggered!"
                  sleep 60
                else
                  echo "ERROR: Failed to trigger restart (HTTP $HTTP_CODE)"
                fi

                RESTART_TRIGGERED=true
              fi
            fi

            [ "$ELAPSED" -gt "$DURATION" ] && break
            sleep 30 &
            wait $! 2>/dev/null || true
          done
